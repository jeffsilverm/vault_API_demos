<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jeff's Vault API demo</title>
</head>
<body>
<script type="text/javascript"> document.writeln("This document was last modified "+document.lastModified + "<br>The URL is:" + window.location.href );</script>
<h2>How to start the vault daemon</h2>
<h3>For development</h3>
<p>For official information, refer to the
    <a href="https://hashicorp.com">Hashicorp</a>
    <a href="https://developer.hashicorp.com/vault/">developer information</a> <a
            href="https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-dev-server">
        getting started development server page</a>.</p>
<p>The really simple way:<br>
<kbd>vault server -dev</kbd>
</p>
<p>To start the vault daemon with TLS:<br>
<kbd>vault server -dev-tls=key.pem</kbd><br>
    This command creates self-signed cert/key/ca certificates in <tt>/tmp/vault-tls*/vault*.pem</tt>.
</p>
<p>When starting in development mode, the server will output 4 important strings which you might need later:
<pre><samp>
export VAULT_ADDR='https://127.0.0.1:8200'
export VAULT_CACERT='/tmp/vault-tls1641483676/vault-ca.pem'
</samp></pre>
<tt>Unseal Key:</tt> <samp>QDwDVu62Kd77SairDCytiZN3vKRJEyZkKwhmySaDLq4=</samp><br>
<tt>Root Token:</tt> <samp>hvs.1eEUU9PWanecYAytOSY61zmC</samp>
</p>


<p>I created a self-signed key (which it turns out I didn't need because the vault server does that for me in -dev
    mode if I use the <tt>-dev-tls</tt> option):
<kbd>openssl req -x509 -newkey rsa:4096 -keyout TLS_key.pem -out TLS_cert.pem -days 365 -nodes</kbd><br>
    .</p>
<p>If I want to create a <u>persistent</u> set of CA, key and cert files, then (create the CA file):<br>
<kbd>openssl genrsa  -out TLS_ca.pem</kbd><br>
    and create the correspondng cert and key files:<br>
 <kbd>openssl req -x509 -newkey rsa:4096 -CA TLS_ca.pem -keyout TLS_key.pem -out TLS_cert.pem -days 365 -nodes</kbd>
    <br>
    <p>I tried commenting out the ca parameter from tls_config.hcl, and then ran this:<br>
    <kbd>openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes \<br>
  -keyout TLS_key.pem -out TLS_cert.pem -subj "/CN=example.com" \<br>
  -addext "subjectAltName=DNS:example.com,DNS:www.example.net,IP:10.0.0.1"</kbd><br>
That allowed the server to start.  It is 5:11 and I have to be cogent for Weight Watchers in 3 hours.
</p>
<p>
</p>
<h3>For productions</h3>
<P>
    <a href="https://developer.hashicorp.com/vault/docs/concepts/seal#recovery-key"></a>
</P>
<p><br></p>
<h2>The configuration file</h2>
<p>For details on how to specify the TLS files, see <a href="https://github.com/hashicorp/vault/issues/17953">issue
        17952</a> in <a href="https://github.com/hashicorp/vault">github</a>.  See also <A
        href="https://developer.hashicorp.com/vault/docs/configuration/listener/tcp">tcp Listener</A>.</p>
<h3>Configuration using environmental variables (envars) </h3>
<p>See
    <A href="https://developer.hashicorp.com/vault/docs/commands#environment-variables">Commands (CLI):
        Environmental Variables</A></p>
<h2>Set or change the number of keys required (threshold) and/or generate new keys (rekey)</h2>
<p>See <a href="https://developer.hashicorp.com/vault/docs/commands/operator/rekey">operator rekey</a>. </p>

<h2>Configuration</h2>
<p>I thought that this table might be helpful.  There are three ways to set configuration for vault: in a
    configuration file (written in Hashicorp configuration language), environmental variables (envars), as arguments
    to the sys/init API call and as attributes of a hvac.Client object</p>
<table>
    <tr>
        <th>Explanation</th>
        <th>envar</th>
        <th>configuration file</th>
        <th>arguments</th>
    </tr>
    <tr>


        <td>Vault authentication token. Conceptually similar to a session token on a website, the VAULT_TOKEN environment
            variable holds the contents of the token. For more information, please see the token concepts page.
</td><!--explanation-->
        <td>VAULT_TOKEN</td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr>
        <td>Address of the Vault server expressed as a URL and port, for example: https://127.0.0.1:8200/.</td><!--explanation-->
        <td>VAULT_ADDR</td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>


VAULT_CLIENT_CERT
Path to a PEM-encoded client certificate on the local disk. This file is used for TLS communication with the Vault server.

VAULT_CLIENT_KEY
Path to an unencrypted, PEM-encoded private key on disk which corresponds to the matching client certificate.

    <tr>
        <td>Path to a PEM-encoded CA certificate file on the local disk. This file is used to verify the Vault server's SSL certificate. This environment variable takes precedence over VAULT_CAPATH.
</td><!--explanation-->
        <td>VAULT_CACERT</td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr>


        <td>Path to a directory of PEM-encoded CA certificate files on the local disk. These certificates are used to verify the Vault server's SSL certificate.
</td><!--explanation-->
        <td>VAULT_CAPATH</td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr>
        <td>Timeout variable. The default value is 60s.</td><!--explanation-->
        <td>VAULT_CLIENT_TIMEOUT</td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr>
        <td>Address that should be used for other cluster members to connect to this node when in High Availability mode.</td><!--explanation-->
        <td>VAULT_CLUSTER_ADDR</td><!--envar-->
        <td>See the <a
                href="https://developer.hashicorp.com/vault/docs/configuration/listener/tcp#tcp-listener-parameters>">TCP Listener page</a>.</td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr>
        <td>Provide Vault output (read/status/write) in the specified format. Valid formats are "table", "json", or "yaml".</td><!--explanation-->
        <td>VAULT_FORMAT</td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr>
        <td>[Enterprise, Server only] Specify a license to use for this node. This takes precedence over #VAULT_LICENSE_PATH and license_path in config.
</td><!--explanation-->
        <td>VAULT_LICENSE</td><!--envar-->
        <td>license_path </td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr>
        <td></td><!--explanation-->
        <td></td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr>
        <td></td><!--explanation-->
        <td></td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr>
        <td></td><!--explanation-->
        <td></td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr>
        <td></td><!--explanation-->
        <td></td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr>
        <td></td><!--explanation-->
        <td></td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    <tr><!-- THIS IS THE TEMPLATE -->
        <td></td><!--explanation-->
        <td></td><!--envar-->
        <td></td><!--config file-->
        <td></td><!--command line arguments-->
    </tr>
    
    <!--



VAULT_MAX_RETRIES
Maximum number of retries when certain error codes are encountered. The default is 2, for three total attempts. Set this to 0 or less to disable retrying.

Error codes that are retried are 412 (client consistency requirement not satisfied) and all 5xx except for 501 (not implemented).

VAULT_REDIRECT_ADDR
Address that should be used when clients are redirected to this node when in High Availability mode.

VAULT_SKIP_VERIFY
Do not verify Vault's presented certificate before communicating with it. Setting this variable is not recommended and voids Vault's security model.

VAULT_TLS_SERVER_NAME
Name to use as the SNI host when connecting via TLS.

VAULT_CLI_NO_COLOR
If provided, Vault output will not include ANSI color escape sequence characters.

VAULT_RATE_LIMIT
This environment variable will limit the rate at which the vault command sends requests to Vault.

This environment variable has the format rate[:burst] (where items in [] are optional). If not specified, the burst value defaults to rate. Both rate and burst are specified in "operations per second". If the environment variable is not specified, then the rate and burst will be unlimited i.e. rate limiting is off by default.

Note: The rate is limited for each invocation of the vault CLI. Since each invocation of the vault CLI typically only makes a few requests, this environment variable is most useful when using the Go Vault client API.

VAULT_NAMESPACE
The namespace to use for the command. Setting this is not necessary but allows using relative paths.

VAULT_SRV_LOOKUP
Enables the client to lookup the host through DNS SRV look up as described in this draft. This is not designed for high-availability, just discovery. The draft specifies that the SRV record lookup is ignored if a port is given.

VAULT_MFA
ENTERPRISE ONLY

MFA credentials in the format mfa_method_name[:key[=value]] (items in [] are optional). Note that when using the environment variable, only one credential can be supplied. If a MFA method expects multiple credential values, or if there are multiple MFA methods specified on a path, then the CLI flag -mfa should be used.

VAULT_HTTP_PROXY
HTTP or HTTPS proxy location which should be used by all requests to access Vault. When present, this overrides the default proxy resolution behavior. Format should be http://server:port or https://server:port.

(See VAULT_PROXY_ADDR below).

VAULT_PROXY_ADDR
HTTP or HTTPS proxy location which should be used by all requests to access Vault. When present, this overrides the default proxy resolution behavior. Format should be http://server:port or https://server:port.
    
    -->
    
</table>
<h2>How to make a self-signed key/cert pair</h2>
<p>This is from <cite><a
        href="https://docs.google.com/presentation/d/1RkMHJK6MAGC-qIen8r1JdUSMPF0EQr2bkbbOz_RzXXM/pub?start=false&loop=false&delayms=3000#slide=id.g10abeba5b5_1_0">
    How to give the NSA the finger using openSSL</a> by Jeff Silverman</cite>.  There is more than one way to do this.
    The reason why the procedure is a little more complicated than others you might see in the literature is that
    vault requires not only key/cert pair, it also needs a pointer to either a certificate authority (CA) or a
    CA certificate, a file.
</p>
<ol>
    <li>Create a root certificate authority (CA) root key/certificate pair<br>
    <kbd>openssl genrsa -out TLS_key.pem 2048<br>
    openssl req -x509 -new -nodes -key TLS_root_key.pem  -sha256 -days 3650  -out  TLS_root_cert.pem</kbd>
    </li>
    <li>Generate a secret key<br>
<kbd>openssl genrsa  -out TLS_key.pem 204</kbd>
        </li>
    <li>Generate a key/certificate pair.
    <kbd>openssl req -new -x509 -CA TLS_root_cert.pem -CAkey TLS_root_key.pem -nodes -sha256 -days 3650 -key
        TLS_key.pem -outform PEM -out TLS_cert.pem</kbd>
    </li>
    <li>These can be checked using the <kbd>openssl s_client</kbd> command.<br>
        <kbd>openssl s_client -CAfile TLS_root_cert.pem -key TLS_key.pem -cert TLS_cert.pem  -connect localhost:8200
        </kbd><br>
    </li>
    
</ol>
</body>
</html>